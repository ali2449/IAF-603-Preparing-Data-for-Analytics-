<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 4: SQL Basics II: Aggregations - IAF 603</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- MathJax CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Custom MathJax Configuration -->
    <script src="./js/mathjax.js"></script>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">IAF 603: Preparing Data for Analytics</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Modules
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="./module1.html">Module 1</a></li>
                            <li><a class="dropdown-item" href="./module2.html">Module 2</a></li>
                            <li><a class="dropdown-item" href="./module3.html">Module 3</a></li>
                            <li><a class="dropdown-item" href="./module4.html">Module 4</a></li>
                            <li><a class="dropdown-item" href="./module5.html">Module 5</a></li>
                            <li><a class="dropdown-item" href="./module6.html">Module 6</a></li>
                            <li><a class="dropdown-item" href="./module7.html">Module 7</a></li>
                            <li><a class="dropdown-item" href="./module8.html">Module 8</a></li>
                            <li><a class="dropdown-item" href="./module9.html">Module 9</a></li>
                            <li><a class="dropdown-item" href="./module10.html">Module 10</a></li>
                            <li><a class="dropdown-item" href="./module11.html">Module 11</a></li>
                            <li><a class="dropdown-item" href="./module12.html">Module 12</a></li>
                            <li><a class="dropdown-item" href="./module13.html">Module 13</a></li>
                            <li><a class="dropdown-item" href="./module14.html">Module 14</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html#contact">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Module Title -->
        <section class="text-center py-5 bg-white rounded shadow">
            <h1 class="display-4 fw-bold text-dark">Module 4: SQL Basics II: Aggregations</h1>
        </section>

        <!-- Module Content -->
        <section class="my-5">
            <div class="bg-white p-4 rounded shadow">
                <!-- Learning Objectives -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Learning Objectives</h2>
                <p>Upon completion of this module, participants will be able to:</p>
                <ul>
                    <li>Utilize SQL aggregate functions (<code>COUNT</code>, <code>SUM</code>, <code>AVG</code>, <code>MIN</code>, <code>MAX</code>) to summarize data.</li>
                    <li>Apply the <code>GROUP BY</code> clause to group rows by one or more columns for aggregation.</li>
                    <li>Use the <code>HAVING</code> clause to filter aggregated results.</li>
                    <li>Combine <code>GROUP BY</code> with <code>WHERE</code> and <code>ORDER BY</code> for comprehensive data analysis.</li>
                    <li>Understand the execution order of SQL clauses when using aggregations.</li>
                    <li>Execute aggregate queries in cloud-based environments like Microsoft Fabric Lakehouse.</li>
                </ul>

                <!-- Introduction to SQL Aggregations -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Introduction to SQL Aggregations</h2>
                <p>Aggregations in SQL allow you to summarize data across multiple rows, transforming detailed records into meaningful insights. This module builds on the <code>SELECT</code>, <code>WHERE</code>, and <code>ORDER BY</code> clauses from Module 3, introducing aggregate functions like <code>COUNT</code>, <code>SUM</code>, <code>AVG</code>, <code>MIN</code>, and <code>MAX</code>. The <code>GROUP BY</code> clause organizes data into groups for aggregation, while <code>HAVING</code> filters those groups. These tools are critical for tasks like calculating total sales, average patient ages, or minimum stock levels in real-world scenarios, such as analyzing healthcare trends in Greensboro, NC, or optimizing a local business's inventory.</p>
                <p>Aggregations are widely used across industries. For example, in healthcare, you might calculate the average length of hospital stays per diagnosis; in retail, total sales by product category; in education, average grades by course. Understanding how to combine these functions with filtering and sorting enhances your ability to extract actionable insights from large datasets efficiently.</p>

                <!-- Aggregate Functions -->
                <h3 class="h4 fw-bold mb-3">Aggregate Functions</h3>
                <p>Aggregate functions process multiple rows to produce a single summary value. Common functions include:</p>
                <ul>
                    <li><strong>COUNT:</strong> Counts the number of rows or non-NULL values in a column.</li>
                    <li><strong>SUM:</strong> Adds up numeric values in a column.</li>
                    <li><strong>AVG:</strong> Calculates the average of numeric values.</li>
                    <li><strong>MIN:</strong> Finds the smallest value in a column.</li>
                    <li><strong>MAX:</strong> Finds the largest value in a column.</li>
                </ul>
                <p><strong>Sample Data (ADMISSIONS Table):</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>hadm_id</th>
                            <th>subject_id</th>
                            <th>admit_time</th>
                            <th>discharge_time</th>
                            <th>diagnosis</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>101</td>
                            <td>1001</td>
                            <td>2025-01-10 08:00:00</td>
                            <td>2025-01-15 12:00:00</td>
                            <td>Pneumonia</td>
                        </tr>
                        <tr>
                            <td>102</td>
                            <td>1002</td>
                            <td>2025-02-01 14:00:00</td>
                            <td>2025-02-03 09:00:00</td>
                            <td>Fracture</td>
                        </tr>
                        <tr>
                            <td>103</td>
                            <td>1001</td>
                            <td>2025-03-05 10:00:00</td>
                            <td>2025-03-12 15:00:00</td>
                            <td>Pneumonia</td>
                        </tr>
                        <tr>
                            <td>104</td>
                            <td>1003</td>
                            <td>2025-04-10 07:00:00</td>
                            <td>2025-04-11 11:00:00</td>
                            <td>Flu</td>
                        </tr>
                    </tbody>
                </table>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Count total admissions
SELECT COUNT(*) AS TotalAdmissions
FROM ADMISSIONS;

-- Count distinct patients
SELECT COUNT(DISTINCT subject_id) AS UniquePatients
FROM ADMISSIONS;

-- Calculate average length of stay (in days)
SELECT AVG(discharge_time - admit_time) AS AvgStayDays
FROM ADMISSIONS;</code></pre>
                </div>
                <p><strong>Explanation:</strong> <code>COUNT(*)</code> counts all rows, while <code>COUNT(DISTINCT subject_id)</code> counts unique patients. <code>AVG</code> computes the average stay duration, useful for hospital resource planning.</p>
                <p><strong>Expanded Example (Sales Table):</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>sale_id</th>
                            <th>product</th>
                            <th>quantity</th>
                            <th>price</th>
                            <th>category</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Laptop</td>
                            <td>2</td>
                            <td>800.00</td>
                            <td>Electronics</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Mouse</td>
                            <td>5</td>
                            <td>20.00</td>
                            <td>Accessories</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Keyboard</td>
                            <td>3</td>
                            <td>50.00</td>
                            <td>Accessories</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Monitor</td>
                            <td>1</td>
                            <td>300.00</td>
                            <td>Electronics</td>
                        </tr>
                    </tbody>
                </table>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Total sales value
SELECT SUM(quantity * price) AS TotalRevenue
FROM Sales;

-- Minimum and maximum price
SELECT MIN(price) AS MinPrice, MAX(price) AS MaxPrice
FROM Sales;</code></pre>
                </div>
                <p><strong>Explanation:</strong> <code>SUM</code> calculates total revenue, while <code>MIN</code> and <code>MAX</code> identify price ranges, aiding pricing strategies.</p>

                <!-- GROUP BY Clause: Grouping Data -->
                <h3 class="h4 fw-bold mb-3">GROUP BY Clause: Grouping Data</h3>
                <p>The <code>GROUP BY</code> clause groups rows with identical values in specified columns into summary rows, applying aggregate functions to each group.</p>
                <ul>
                    <li><strong>Purpose:</strong> Summarize data by categories, e.g., total admissions per diagnosis.</li>
                    <li><strong>Rules:</strong> Non-aggregated columns in <code>SELECT</code> must appear in <code>GROUP BY</code>.</li>
                </ul>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Count admissions by diagnosis
SELECT diagnosis, COUNT(*) AS AdmissionCount
FROM ADMISSIONS
GROUP BY diagnosis;

-- Average stay by diagnosis
SELECT diagnosis, AVG(discharge_time - admit_time) AS AvgStayDays
FROM ADMISSIONS
GROUP BY diagnosis;</code></pre>
                </div>
                <p><strong>Explanation:</strong> The first query counts admissions per diagnosis, the second calculates average stay length, both grouped by diagnosis for healthcare analysis.</p>
                <p><strong>Expanded Example (Sales by Category):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Total revenue by category
SELECT category, SUM(quantity * price) AS CategoryRevenue
FROM Sales
GROUP BY category;

-- Count and average price by category
SELECT
    category,
    COUNT(*) AS ProductCount,
    AVG(price) AS AvgPrice
FROM Sales
GROUP BY category;</code></pre>
                </div>
                <p><strong>Explanation:</strong> These queries summarize sales performance, helping identify high-value categories or pricing trends.</p>

                <!-- HAVING Clause: Filtering Groups -->
                <h3 class="h4 fw-bold mb-3">HAVING Clause: Filtering Groups</h3>
                <p>The <code>HAVING</code> clause filters grouped results, applied after <code>GROUP BY</code>, unlike <code>WHERE</code> which filters individual rows before aggregation.</p>
                <ul>
                    <li><strong>Use Case:</strong> Filter groups based on aggregate values, e.g., only diagnoses with more than 5 admissions.</li>
                    <li><strong>Syntax:</strong> <code>HAVING condition</code>, using aggregates like <code>COUNT(*) > 5</code>.</li>
                </ul>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Diagnoses with more than one admission
SELECT diagnosis, COUNT(*) AS AdmissionCount
FROM ADMISSIONS
GROUP BY diagnosis
HAVING COUNT(*) > 1;

-- Diagnoses with average stay > 5 days
SELECT diagnosis, AVG(discharge_time - admit_time) AS AvgStayDays
FROM ADMISSIONS
GROUP BY diagnosis
HAVING AVG(discharge_time - admit_time) > INTERVAL '5 days';</code></pre>
                </div>
                <p><strong>Explanation:</strong> <code>HAVING</code> filters groups, e.g., only showing diagnoses with multiple admissions or long average stays.</p>
                <p><strong>Expanded Example (High-Value Categories):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Categories with total revenue > 1000
SELECT category, SUM(quantity * price) AS CategoryRevenue
FROM Sales
GROUP BY category
HAVING SUM(quantity * price) > 1000;</code></pre>
                </div>
                <p><strong>Explanation:</strong> This identifies high-performing categories for targeted marketing.</p>

                <!-- Combining WHERE, GROUP BY, HAVING, and ORDER BY -->
                <h3 class="h4 fw-bold mb-3">Combining WHERE, GROUP BY, HAVING, and ORDER BY</h3>
                <p>These clauses work together to filter, group, filter groups, and sort results for comprehensive analysis.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Admissions in 2025, grouped by diagnosis, with count > 1, sorted by count
SELECT diagnosis, COUNT(*) AS AdmissionCount
FROM ADMISSIONS
WHERE EXTRACT(YEAR FROM admit_time) = 2025
GROUP BY diagnosis
HAVING COUNT(*) > 1
ORDER BY AdmissionCount DESC;</code></pre>
                </div>
                <p><strong>Explanation:</strong> <code>WHERE</code> filters 2025 admissions, <code>GROUP BY</code> groups by diagnosis, <code>HAVING</code> keeps frequent diagnoses, and <code>ORDER BY</code> sorts by count.</p>
                <p><strong>Expanded Example (Employee Salaries):</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>emp_id</th>
                            <th>name</th>
                            <th>salary</th>
                            <th>department</th>
                            <th>hire_date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>John Doe</td>
                            <td>60000</td>
                            <td>IT</td>
                            <td>2024-01-15</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Jane Smith</td>
                            <td>75000</td>
                            <td>HR</td>
                            <td>2023-06-20</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Mike Johnson</td>
                            <td>55000</td>
                            <td>IT</td>
                            <td>2024-03-10</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Sara Lee</td>
                            <td>80000</td>
                            <td>Finance</td>
                            <td>2023-11-01</td>
                        </tr>
                    </tbody>
                </table>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Average salary by department for employees hired in 2023, with avg > 70000
SELECT department, AVG(salary) AS AvgSalary
FROM Employees
WHERE EXTRACT(YEAR FROM hire_date) = 2023
GROUP BY department
HAVING AVG(salary) > 70000
ORDER BY AvgSalary DESC;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Filters 2023 hires, groups by department, keeps high-salary departments, and sorts by average salary.</p>

                <!-- Order of Execution -->
                <h3 class="h4 fw-bold mb-3">Order of Execution</h3>
                <p>SQL executes clauses in this order: <code>FROM</code>, <code>WHERE</code>, <code>GROUP BY</code>, <code>HAVING</code>, <code>SELECT</code>, <code>ORDER BY</code>. This means <code>HAVING</code> can use aggregates, but <code>WHERE</code> cannot.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Valid: Filter groups with HAVING
SELECT diagnosis, COUNT(*) AS AdmissionCount
FROM ADMISSIONS
GROUP BY diagnosis
HAVING COUNT(*) > 1;

-- Invalid: Can't use aggregate in WHERE
-- SELECT diagnosis, COUNT(*) FROM ADMISSIONS WHERE COUNT(*) > 1 GROUP BY diagnosis; -- Error</code></pre>
                </div>
                <p><strong>Explanation:</strong> <code>HAVING</code> filters after grouping, ensuring correct aggregate-based filtering.</p>

                <!-- Running Aggregations in Microsoft Fabric -->
                <h3 class="h4 fw-bold mb-3">Running Aggregations in Microsoft Fabric Lakehouse</h3>
                <p>In Microsoft Fabric, aggregations are executed on large-scale data lakes using SQL endpoints or notebooks, leveraging distributed computing for efficiency.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Aggregate survey data in Fabric
SELECT city, AVG(satisfaction_score) AS AvgScore
FROM survey_lakehouse.Responses
WHERE response_date >= '2025-01-01'
GROUP BY city
HAVING COUNT(*) > 100
ORDER BY AvgScore DESC;</code></pre>
                </div>
                <p><strong>Explanation:</strong> This aggregates survey scores by city for recent responses, filtering for significant sample sizes.</p>

                <!-- Assessments -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Assessments</h2>
                <ol>
                    <li><strong>Conceptual Question:</strong> Explain the difference between <code>WHERE</code> and <code>HAVING</code>. Provide a scenario where <code>HAVING</code> is necessary.</li>
                    <li><strong>SQL Coding Task:</strong> Using the Sales table, write a query to find the total revenue and number of sales per category, only for categories with total revenue > 500, sorted by revenue descending.</li>
                    <li><strong>Application Scenario:</strong> For a Greensboro hospital, query the ADMISSIONS table to find diagnoses with more than 3 admissions in 2025, showing average stay length, sorted by count.</li>
                    <li><strong>Expanded Task:</strong> For a university database, query a Grades table to calculate average grades by course for students enrolled in 2024, only for courses with > 10 students, sorted by average grade.</li>
                </ol>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-3 text-center">
        <p class="text-muted mb-0">&copy; 2025 Ali Noori, UNCG. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <!-- Highlight.js Initialization -->
    <script>hljs.highlightAll();</script>
    <!-- Custom Copy Functionality -->
    <script>
        function copyCode(button) {
            const code = button.nextElementSibling.querySelector('code');
            navigator.clipboard.writeText(code.innerText).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            });
        }
    </script>
</body>
</html>