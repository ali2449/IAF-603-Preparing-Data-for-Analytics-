<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 7: Subqueries - IAF 603</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- MathJax CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Custom MathJax Configuration -->
    <script src="./js/mathjax.js"></script>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">IAF 603: Preparing Data for Analytics</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Modules
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="./module1.html">Module 1</a></li>
                            <li><a class="dropdown-item" href="./module2.html">Module 2</a></li>
                            <li><a class="dropdown-item" href="./module3.html">Module 3</a></li>
                            <li><a class="dropdown-item" href="./module4.html">Module 4</a></li>
                            <li><a class="dropdown-item" href="./module5.html">Module 5</a></li>
                            <li><a class="dropdown-item" href="./module6.html">Module 6</a></li>
                            <li><a class="dropdown-item" href="./module7.html">Module 7</a></li>
                            <li><a class="dropdown-item" href="./module8.html">Module 8</a></li>
                            <li><a class="dropdown-item" href="./module9.html">Module 9</a></li>
                            <li><a class="dropdown-item" href="./module10.html">Module 10</a></li>
                            <li><a class="dropdown-item" href="./module11.html">Module 11</a></li>
                            <li><a class="dropdown-item" href="./module12.html">Module 12</a></li>
                            <li><a class="dropdown-item" href="./module13.html">Module 13</a></li>
                            <li><a class="dropdown-item" href="./module14.html">Module 14</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html#contact">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Module Title -->
        <section class="text-center py-5 bg-white rounded shadow">
            <h1 class="display-4 fw-bold text-dark">Module 7: Subqueries</h1>
        </section>

        <!-- Module Content -->
        <section class="my-5">
            <div class="bg-white p-4 rounded shadow">
                <!-- Learning Objectives -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Learning Objectives</h2>
                <p>Upon completion of this module, participants will be able to:</p>
                <ul>
                    <li>Learn to use subqueries (scalar, multi-row, correlated) in <code>WHERE</code>, <code>SELECT</code>, and <code>FROM</code> clauses for multi-step data retrieval and comparisons.</li>
                    <li>Understand the differences between scalar, multi-row, and correlated subqueries and their appropriate use cases.</li>
                    <li>Apply subqueries in combination with joins, aggregations, and other SQL features for complex data analysis.</li>
                    <li>Execute subquery-based queries in cloud-based environments like Microsoft Fabric Lakehouse.</li>
                </ul>

                <!-- Introduction to Subqueries -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Introduction to Subqueries</h2>
                <p>Subqueries are queries nested within other queries, allowing multi-step data retrieval and comparisons without creating temporary tables. This module covers subqueries in <code>WHERE</code>, <code>SELECT</code>, and <code>FROM</code> clauses, including scalar, multi-row, and correlated types. Subqueries are powerful for complex analysis, such as finding patients with above-average ages or admissions longer than the average stay. In real-world applications, like a Greensboro hospital, subqueries can identify high-risk patients by comparing individual metrics to aggregates. In retail, they can find products priced above the category average.</p>
                <p>Subqueries enhance query modularity and efficiency, avoiding multiple separate queries. They are especially useful in scenarios where data needs to be compared against derived values, like benchmarks or thresholds calculated on the fly. Understanding subquery types and their performance implications is key for optimizing queries in large datasets.</p>

                <!-- Types of Subqueries -->
                <h3 class="h4 fw-bold mb-3">Types of Subqueries</h3>
                <p>Subqueries are classified by their return values and placement: scalar (single value), multi-row (multiple values), and correlated (dependent on the outer query).</p>
                <ul>
                    <li><strong>Scalar Subquery:</strong> Returns one row and one column, used in <code>SELECT</code> or <code>WHERE</code> for comparisons.</li>
                    <li><strong>Multi-Row Subquery:</strong> Returns multiple rows, often used with <code>IN</code>, <code>ANY</code>, or <code>ALL</code> in <code>WHERE</code>.</li>
                    <li><strong>Correlated Subquery:</strong> References columns from the outer query, executing for each row of the outer query.</li>
                </ul>

                <!-- Sample Data -->
                <h4 class="h5 fw-bold mb-2">Sample Data</h4>
                <p><strong>PATIENTS Table:</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>subject_id</th>
                            <th>name</th>
                            <th>age</th>
                            <th>gender</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1001</td>
                            <td>Alice Smith</td>
                            <td>45</td>
                            <td>Female</td>
                        </tr>
                        <tr>
                            <td>1002</td>
                            <td>Bob Johnson</td>
                            <td>32</td>
                            <td>Male</td>
                        </tr>
                        <tr>
                            <td>1003</td>
                            <td>Carol White</td>
                            <td>58</td>
                            <td>Female</td>
                        </tr>
                        <tr>
                            <td>1004</td>
                            <td>David Brown</td>
                            <td>67</td>
                            <td>Male</td>
                        </tr>
                        <tr>
                            <td>1005</td>
                            <td>Eve Davis</td>
                            <td>29</td>
                            <td>Female</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>ADMISSIONS Table:</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>hadm_id</th>
                            <th>subject_id</th>
                            <th>admit_time</th>
                            <th>discharge_time</th>
                            <th>diagnosis</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>101</td>
                            <td>1001</td>
                            <td>2025-01-10 08:00:00</td>
                            <td>2025-01-15 12:00:00</td>
                            <td>Pneumonia</td>
                        </tr>
                        <tr>
                            <td>102</td>
                            <td>1002</td>
                            <td>2025-02-01 14:00:00</td>
                            <td>2025-02-03 09:00:00</td>
                            <td>Fracture</td>
                        </tr>
                        <tr>
                            <td>103</td>
                            <td>1001</td>
                            <td>2025-03-05 10:00:00</td>
                            <td>2025-03-12 15:00:00</td>
                            <td>Pneumonia</td>
                        </tr>
                        <tr>
                            <td>104</td>
                            <td>1003</td>
                            <td>2025-04-10 07:00:00</td>
                            <td>2025-04-11 11:00:00</td>
                            <td>Flu</td>
                        </tr>
                        <tr>
                            <td>105</td>
                            <td>1004</td>
                            <td>2025-05-15 09:00:00</td>
                            <td>2025-05-20 14:00:00</td>
                            <td>Heart Disease</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Subqueries in WHERE Clause -->
                <h4 class="h5 fw-bold mb-2">Subqueries in WHERE Clause</h4>
                <p>Subqueries in <code>WHERE</code> filter rows based on results from another query.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Patients older than the average age
SELECT name, age
FROM PATIENTS
WHERE age > (SELECT AVG(age) FROM PATIENTS);</code></pre>
                </div>
                <p><strong>Explanation:</strong> The subquery calculates the average age (e.g., 46.2), and the outer query filters patients older than that. This is a scalar subquery.</p>
                <p><strong>Expanded Example (Patients with Admissions for Pneumonia):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Patients who have been admitted for Pneumonia
SELECT name, age
FROM PATIENTS
WHERE subject_id IN (SELECT subject_id FROM ADMISSIONS WHERE diagnosis = 'Pneumonia');</code></pre>
                </div>
                <p><strong>Explanation:</strong> This multi-row subquery finds subject_ids with Pneumonia admissions, then the outer query retrieves those patients' details.</p>
                <p><strong>Expanded Example (Patients with More Admissions than Average):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Patients with more admissions than average (correlated)
SELECT p.name, p.age, 
       (SELECT COUNT(*) FROM ADMISSIONS a WHERE a.subject_id = p.subject_id) AS AdmissionCount
FROM PATIENTS p
WHERE (SELECT COUNT(*) FROM ADMISSIONS a WHERE a.subject_id = p.subject_id) > (SELECT AVG(AdmissionCount) FROM (SELECT COUNT(*) AS AdmissionCount FROM ADMISSIONS GROUP BY subject_id) AS Sub);</code></pre>
                </div>
                <p><strong>Explanation:</strong> The correlated subquery counts admissions per patient, and the outer query filters those above average.</p>

                <!-- Subqueries in SELECT Clause -->
                <h4 class="h5 fw-bold mb-2">Subqueries in SELECT Clause</h4>
                <p>Subqueries in <code>SELECT</code> add derived columns based on related data.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Patients with their number of admissions
SELECT name, age,
       (SELECT COUNT(*) FROM ADMISSIONS a WHERE a.subject_id = p.subject_id) AS AdmissionCount
FROM PATIENTS p;</code></pre>
                </div>
                <p><strong>Explanation:</strong> This correlated subquery adds an admission count column for each patient.</p>
                <p><strong>Expanded Example (Patients with Latest Admission Date):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Patients with their latest admission date
SELECT name, age,
       (SELECT MAX(admit_time) FROM ADMISSIONS a WHERE a.subject_id = p.subject_id) AS LatestAdmission
FROM PATIENTS p;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Uses a scalar subquery to find the most recent admission date per patient.</p>

                <!-- Subqueries in FROM Clause -->
                <h4 class="h5 fw-bold mb-2">Subqueries in FROM Clause</h4>
                <p>Subqueries in <code>FROM</code> act as derived tables for further querying.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Average age of patients with multiple admissions
SELECT AVG(age) AS AvgAgeMultiAdmissions
FROM (
    SELECT p.subject_id, p.age
    FROM PATIENTS p
    INNER JOIN ADMISSIONS a ON p.subject_id = a.subject_id
    GROUP BY p.subject_id, p.age
    HAVING COUNT(a.hadm_id) > 1
) AS MultiAdmissionPatients;</code></pre>
                </div>
                <p><strong>Explanation:</strong> The subquery derives patients with multiple admissions, and the outer query averages their ages.</p>
                <p><strong>Expanded Example (Total Admissions by Gender):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Total admissions by gender
SELECT gender, AdmissionCount
FROM (
    SELECT p.gender, COUNT(a.hadm_id) AS AdmissionCount
    FROM PATIENTS p
    INNER JOIN ADMISSIONS a ON p.subject_id = a.subject_id
    GROUP BY p.gender
) AS GenderAdmissions
ORDER BY AdmissionCount DESC;</code></pre>
                </div>
                <p><strong>Explanation:</strong> The subquery aggregates admissions by gender, and the outer query sorts the results.</p>

                <!-- Correlated vs. Non-Correlated Subqueries -->
                <h3 class="h4 fw-bold mb-3">Correlated vs. Non-Correlated Subqueries</h3>
                <p>Non-correlated subqueries run independently, while correlated ones depend on the outer query, executing per row (potentially slower but powerful).</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Non-correlated: Patients with age above overall average
SELECT name, age
FROM PATIENTS
WHERE age > (SELECT AVG(age) FROM PATIENTS);

-- Correlated: Patients with more admissions than average for their gender
SELECT p.name, p.gender, 
       (SELECT COUNT(*) FROM ADMISSIONS a WHERE a.subject_id = p.subject_id) AS Count
FROM PATIENTS p
WHERE (SELECT COUNT(*) FROM ADMISSIONS a WHERE a.subject_id = p.subject_id) > 
      (SELECT AVG(AdmissionCount) FROM (
          SELECT COUNT(*) AS AdmissionCount FROM ADMISSIONS GROUP BY subject_id, 
          (SELECT gender FROM PATIENTS WHERE subject_id = ADMISSIONS.subject_id)
      ) AS Sub WHERE Sub.gender = p.gender);</code></pre>
                </div>
                <p><strong>Explanation:</strong> The non-correlated runs once, the correlated per patient, comparing to gender-specific averages.</p>

                <!-- Subqueries in Microsoft Fabric -->
                <h3 class="h4 fw-bold mb-3">Subqueries in Microsoft Fabric Lakehouse</h3>
                <p>Fabric supports subqueries for big data, optimizing execution across distributed systems.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Survey respondents with above-average scores
SELECT respondent_id, satisfaction_score
FROM survey_lakehouse.Responses
WHERE satisfaction_score > (SELECT AVG(satisfaction_score) FROM survey_lakehouse.Responses);</code></pre>
                </div>
                <p><strong>Explanation:</strong> Filters high-satisfaction responses using a scalar subquery.</p>

                <!-- Assessments -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Assessments</h2>
                <ol>
                    <li><strong>Conceptual Question:</strong> Explain the difference between correlated and non-correlated subqueries. When is a correlated subquery necessary?</li>
                    <li><strong>SQL Coding Task:</strong> Using PATIENTS and ADMISSIONS, find patients with more admissions than the average number of admissions.</li>
                    <li><strong>Application Scenario:</strong> For a Greensboro retail store, use a subquery to find products sold more than the average quantity in their category.</li>
                    <li><strong>Expanded Task:</strong> For a university database, query to find students with GPA higher than the departmental average, using a correlated subquery.</li>
                </ol>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-3 text-center">
        <p class="text-muted mb-0">&copy; 2025 Ali Noori, UNCG. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <!-- Highlight.js Initialization -->
    <script>hljs.highlightAll();</script>
    <!-- Custom Copy Functionality -->
    <script>
        function copyCode(button) {
            const code = button.nextElementSibling.querySelector('code');
            navigator.clipboard.writeText(code.innerText).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            });
        }
    </script>
</body>
</html>
</xaiArtifact>