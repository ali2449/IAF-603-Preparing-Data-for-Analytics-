<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 9: Data Cleaning in SQL - IAF 603</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- MathJax CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Custom MathJax Configuration -->
    <script src="./js/mathjax.js"></script>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">IAF 603: Preparing Data for Analytics</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Modules
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="./module1.html">Module 1</a></li>
                            <li><a class="dropdown-item" href="./module2.html">Module 2</a></li>
                            <li><a class="dropdown-item" href="./module3.html">Module 3</a></li>
                            <li><a class="dropdown-item" href="./module4.html">Module 4</a></li>
                            <li><a class="dropdown-item" href="./module5.html">Module 5</a></li>
                            <li><a class="dropdown-item" href="./module6.html">Module 6</a></li>
                            <li><a class="dropdown-item" href="./module7.html">Module 7</a></li>
                            <li><a class="dropdown-item" href="./module8.html">Module 8</a></li>
                            <li><a class="dropdown-item" href="./module9.html">Module 9</a></li>
                            <li><a class="dropdown-item" href="./module10.html">Module 10</a></li>
                            <li><a class="dropdown-item" href="./module11.html">Module 11</a></li>
                            <li><a class="dropdown-item" href="./module12.html">Module 12</a></li>
                            <li><a class="dropdown-item" href="./module13.html">Module 13</a></li>
                            <li><a class="dropdown-item" href="./module14.html">Module 14</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html#contact">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Module Title -->
        <section class="text-center py-5 bg-white rounded shadow">
            <h1 class="display-4 fw-bold text-dark">Module 9: Data Cleaning in SQL</h1>
        </section>

        <!-- Module Content -->
        <section class="my-5">
            <div class="bg-white p-4 rounded shadow">
                <!-- Learning Objectives -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Learning Objectives</h2>
                <p>Upon completion of this module, participants will be able to:</p>
                <ul>
                    <li>Develop strategies for removing duplicates in SQL using <code>DISTINCT</code> and <code>ROW_NUMBER()</code>.</li>
                    <li>Handle missing values effectively using <code>COALESCE</code>, <code>IS NULL</code>, and conditional logic.</li>
                    <li>Normalize text data to ensure consistency using string functions like <code>UPPER</code>, <code>TRIM</code>, and <code>REPLACE</code>.</li>
                    <li>Apply data cleaning techniques in combination with joins, aggregations, and other SQL features for comprehensive data preparation.</li>
                    <li>Execute data cleaning operations in cloud-based environments like Microsoft Fabric Lakehouse.</li>
                </ul>

                <!-- Introduction to Data Cleaning in SQL -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Introduction to Data Cleaning in SQL</h2>
                <p>Data cleaning is a critical step in preparing datasets for analysis, addressing issues like duplicates, missing values, and inconsistent formats. This module explores SQL techniques such as <code>DISTINCT</code>, <code>ROW_NUMBER()</code>, and <code>COALESCE</code>, alongside string functions from Module 8, to clean data effectively. In real-world scenarios, such as managing patient records in a Greensboro hospital or sales data for a local retailer, clean data ensures accurate insights. For example, duplicate patient entries can skew treatment statistics, while inconsistent product names can disrupt inventory analysis. Mastering these techniques ensures datasets are reliable and ready for advanced analytics.</p>
                <p>Data cleaning in SQL is powerful because it allows in-database transformations, reducing the need for external tools. By combining these methods with joins and aggregations, you can create robust data preparation pipelines. This module emphasizes practical strategies to handle common data quality issues, ensuring consistency, completeness, and accuracy.</p>

                <!-- Sample Data -->
                <h3 class="h4 fw-bold mb-3">Sample Data</h3>
                <p><strong>PATIENTS Table:</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>subject_id</th>
                            <th>name</th>
                            <th>email</th>
                            <th>address</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1001</td>
                            <td>Alice Smith  </td>
                            <td>alice.smith@email.com</td>
                            <td>123 Main St, Greensboro</td>
                        </tr>
                        <tr>
                            <td>1001</td>
                            <td>Alice SMITH</td>
                            <td>alice.smith@email.com</td>
                            <td>123 Main St, GSO</td>
                        </tr>
                        <tr>
                            <td>1002</td>
                            <td>Bob Johnson</td>
                            <td>NULL</td>
                            <td>456 Oak Ave, greensboro</td>
                        </tr>
                        <tr>
                            <td>1003</td>
                            <td>Carol White</td>
                            <td>carol.white@email.com</td>
                            <td>NULL</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>ADMISSIONS Table:</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>hadm_id</th>
                            <th>subject_id</th>
                            <th>admit_time</th>
                            <th>diagnosis</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>101</td>
                            <td>1001</td>
                            <td>2025-01-10 08:00:00</td>
                            <td>Pneumonia</td>
                        </tr>
                        <tr>
                            <td>101</td>
                            <td>1001</td>
                            <td>2025-01-10 08:00:00</td>
                            <td>Pneumonia</td>
                        </tr>
                        <tr>
                            <td>102</td>
                            <td>1002</td>
                            <td>2025-02-01 14:00:00</td>
                            <td>Fracture</td>
                        </tr>
                        <tr>
                            <td>103</td>
                            <td>1003</td>
                            <td>2025-03-05 10:00:00</td>
                            <td>NULL</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Removing Duplicates -->
                <h3 class="h4 fw-bold mb-3">Removing Duplicates</h3>
                <p>Duplicates can distort analysis, such as overcounting admissions. Use <code>DISTINCT</code> for simple deduplication or <code>ROW_NUMBER()</code> for more complex scenarios.</p>
                <ul>
                    <li><strong>DISTINCT:</strong> Removes duplicate rows based on selected columns.</li>
                    <li><strong>ROW_NUMBER():</strong> Assigns a unique number to rows within a partition, allowing identification of duplicates.</li>
                </ul>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Remove duplicate admissions using DISTINCT
SELECT DISTINCT hadm_id, subject_id, admit_time, diagnosis
FROM ADMISSIONS;

-- Remove duplicates using ROW_NUMBER()
WITH RankedAdmissions AS (
    SELECT
        hadm_id,
        subject_id,
        admit_time,
        diagnosis,
        ROW_NUMBER() OVER (PARTITION BY hadm_id, subject_id, admit_time, diagnosis ORDER BY hadm_id) AS rn
    FROM ADMISSIONS
)
SELECT hadm_id, subject_id, admit_time, diagnosis
FROM RankedAdmissions
WHERE rn = 1;</code></pre>
                </div>
                <p><strong>Explanation:</strong> <code>DISTINCT</code> removes exact duplicate admission rows. <code>ROW_NUMBER()</code> assigns numbers within groups of identical rows, keeping only the first instance (rn = 1).</p>
                <p><strong>Expanded Example (Sales Table):</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>sale_id</th>
                            <th>product</th>
                            <th>quantity</th>
                            <th>price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Laptop</td>
                            <td>2</td>
                            <td>800.00</td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>Laptop</td>
                            <td>2</td>
                            <td>800.00</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Mouse</td>
                            <td>5</td>
                            <td>20.00</td>
                        </tr>
                    </tbody>
                </table>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Remove duplicate sales
WITH RankedSales AS (
    SELECT
        sale_id,
        product,
        quantity,
        price,
        ROW_NUMBER() OVER (PARTITION BY sale_id, product, quantity, price ORDER BY sale_id) AS rn
    FROM Sales
)
SELECT sale_id, product, quantity, price
FROM RankedSales
WHERE rn = 1;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Deduplicates sales records, ensuring accurate revenue calculations.</p>

                <!-- Handling Missing Values -->
                <h3 class="h4 fw-bold mb-3">Handling Missing Values</h3>
                <p>Missing values (NULLs) can skew analysis. Use <code>IS NULL</code> to identify them, <code>COALESCE</code> to provide defaults, and <code>CASE</code> for conditional handling.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Identify patients with missing email or address
SELECT subject_id, name
FROM PATIENTS
WHERE email IS NULL OR address IS NULL;

-- Replace NULL email with 'Not Provided'
SELECT subject_id, COALESCE(email, 'Not Provided') AS CleanEmail
FROM PATIENTS;

-- Replace NULL diagnosis with 'Pending'
SELECT hadm_id, COALESCE(diagnosis, 'Pending') AS CleanDiagnosis
FROM ADMISSIONS;</code></pre>
                </div>
                <p><strong>Explanation:</strong> The first query finds incomplete patient records. <code>COALESCE</code> provides defaults for missing emails and diagnoses, ensuring consistent data.</p>
                <p><strong>Expanded Example (Orders Table):</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>order_id</th>
                            <th>customer_id</th>
                            <th>order_date</th>
                            <th>total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>101</td>
                            <td>1</td>
                            <td>2025-01-15</td>
                            <td>150.00</td>
                        </tr>
                        <tr>
                            <td>102</td>
                            <td>2</td>
                            <td>NULL</td>
                            <td>300.00</td>
                        </tr>
                        <tr>
                            <td>103</td>
                            <td>1</td>
                            <td>2025-03-10</td>
                            <td>NULL</td>
                        </tr>
                    </tbody>
                </table>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Replace NULL order_date with current date
SELECT order_id, COALESCE(order_date, CURRENT_DATE) AS CleanOrderDate
FROM Orders;

-- Flag orders with missing total
SELECT
    order_id,
    CASE
        WHEN total IS NULL THEN 'Missing'
        ELSE 'Valid'
    END AS TotalStatus
FROM Orders;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Handles missing order dates and flags missing totals for retail analysis.</p>

                <!-- Normalizing Text Data -->
                <h3 class="h4 fw-bold mb-3">Normalizing Text Data</h3>
                <p>Text normalization ensures consistency using functions like <code>UPPER</code>, <code>TRIM</code>, and <code>REPLACE</code>.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Standardize patient names and addresses
SELECT
    subject_id,
    TRIM(UPPER(name)) AS CleanName,
    REPLACE(UPPER(address), 'GSO', 'GREENSBORO') AS CleanAddress
FROM PATIENTS;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Removes spaces, converts names to uppercase, and standardizes city names.</p>
                <p><strong>Expanded Example (Products Table):</strong></p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>product_id</th>
                            <th>product_name</th>
                            <th>category</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Laptop   </td>
                            <td>ELECTRONICS</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>MOUSE</td>
                            <td>Accessories </td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Keyboard</td>
                            <td>Electronics</td>
                        </tr>
                    </tbody>
                </table>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Normalize product names and categories
SELECT
    product_id,
    TRIM(LOWER(product_name)) AS CleanProductName,
    TRIM(UPPER(category)) AS CleanCategory
FROM Products;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Standardizes product names to lowercase and categories to uppercase, ensuring uniformity.</p>

                <!-- Combining Cleaning Techniques -->
                <h3 class="h4 fw-bold mb-3">Combining Cleaning Techniques</h3>
                <p>Combine deduplication, NULL handling, and text normalization with joins for robust cleaning.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Clean patient data and join with admissions
WITH CleanPatients AS (
    SELECT DISTINCT
        subject_id,
        TRIM(UPPER(name)) AS CleanName,
        COALESCE(email, 'Not Provided') AS CleanEmail,
        REPLACE(COALESCE(address, 'Unknown'), 'GSO', 'GREENSBORO') AS CleanAddress
    FROM PATIENTS
)
SELECT
    cp.CleanName,
    cp.CleanEmail,
    cp.CleanAddress,
    a.diagnosis
FROM CleanPatients cp
LEFT JOIN ADMISSIONS a ON cp.subject_id = a.subject_id;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Deduplicates patients, standardizes names and addresses, handles NULLs, and joins with admissions for a clean dataset.</p>
                <p><strong>Expanded Example (Sales and Customers):</strong></p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Clean and join customer and sales data
WITH CleanCustomers AS (
    SELECT DISTINCT
        customer_id,
        TRIM(LOWER(name)) AS CleanName,
        COALESCE(email, 'Not Provided') AS CleanEmail
    FROM Customers
)
SELECT
    cc.CleanName,
    cc.CleanEmail,
    SUM(s.quantity * s.price) AS TotalRevenue
FROM CleanCustomers cc
LEFT JOIN Sales s ON cc.customer_id = s.customer_id
GROUP BY cc.CleanName, cc.CleanEmail;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Cleans customer data and aggregates sales revenue, ensuring accurate reporting.</p>

                <!-- Data Cleaning in Microsoft Fabric -->
                <h3 class="h4 fw-bold mb-3">Data Cleaning in Microsoft Fabric Lakehouse</h3>
                <p>Fabric supports scalable data cleaning with SQL.</p>
                <div class="code-block">
                    <button class="btn btn-sm btn-secondary copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre><code class="language-sql">-- Clean survey data in Fabric
WITH CleanResponses AS (
    SELECT DISTINCT
        respondent_id,
        TRIM(UPPER(respondent_name)) AS CleanName,
        COALESCE(satisfaction_score, 0) AS CleanScore
    FROM survey_lakehouse.Responses
)
SELECT CleanName, AVG(CleanScore) AS AvgScore
FROM CleanResponses
GROUP BY CleanName;</code></pre>
                </div>
                <p><strong>Explanation:</strong> Deduplicates and cleans survey data, averaging scores for analysis.</p>

                <!-- Assessments -->
                <h2 class="h3 fw-bold border-bottom pb-2 mb-4">Assessments</h2>
                <ol>
                    <li><strong>Conceptual Question:</strong> Explain the difference between <code>DISTINCT</code> and <code>ROW_NUMBER()</code> for deduplication. When is <code>ROW_NUMBER()</code> preferred?</li>
                    <li><strong>SQL Coding Task:</strong> Using the PATIENTS table, write a query to deduplicate records based on subject_id and email, standardizing names and handling NULL addresses.</li>
                    <li><strong>Application Scenario:</strong> For a Greensboro retailer, clean the Products table by removing duplicates and standardizing category names, then join with Sales to calculate total revenue.</li>
                    <li><strong>Expanded Task:</strong> For a university database, deduplicate student records, handle missing GPAs, and standardize major names, then join with Enrollments to count courses per student.</li>
                </ol>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-3 text-center">
        <p class="text-muted mb-0">&copy; 2025 Ali Noori, UNCG. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <!-- Highlight.js Initialization -->
    <script>hljs.highlightAll();</script>
    <!-- Custom Copy Functionality -->
    <script>
        function copyCode(button) {
            const code = button.nextElementSibling.querySelector('code');
            navigator.clipboard.writeText(code.innerText).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            });
        }
    </script>
</body>
</html>